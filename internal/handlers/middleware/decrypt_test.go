package middleware

import (
	"io"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/go-chi/chi/v5"
	"github.com/go-resty/resty/v2"
	"github.com/stretchr/testify/suite"

	"github.com/fishus/go-advanced-metrics/internal/cryptokey"
)

var (
	publicKeyRaw  = []byte{0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x42, 0x45, 0x47, 0x49, 0x4e, 0x20, 0x50, 0x55, 0x42, 0x4c, 0x49, 0x43, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0xd, 0xa, 0x4d, 0x49, 0x49, 0x42, 0x49, 0x54, 0x41, 0x4e, 0x42, 0x67, 0x6b, 0x71, 0x68, 0x6b, 0x69, 0x47, 0x39, 0x77, 0x30, 0x42, 0x41, 0x51, 0x45, 0x46, 0x41, 0x41, 0x4f, 0x43, 0x41, 0x51, 0x34, 0x41, 0x4d, 0x49, 0x49, 0x42, 0x43, 0x51, 0x4b, 0x43, 0x41, 0x51, 0x42, 0x56, 0x4b, 0x6f, 0x4a, 0x46, 0x6e, 0x30, 0x4d, 0x6a, 0x37, 0x59, 0x52, 0x59, 0x55, 0x4c, 0x4c, 0x36, 0x49, 0x63, 0x42, 0x43, 0xd, 0xa, 0x69, 0x49, 0x45, 0x52, 0x49, 0x2f, 0x6f, 0x2f, 0x30, 0x46, 0x47, 0x56, 0x53, 0x74, 0x61, 0x56, 0x75, 0x6e, 0x76, 0x52, 0x4f, 0x6f, 0x53, 0x37, 0x2f, 0x57, 0x6c, 0x7a, 0x62, 0x6b, 0x75, 0x6c, 0x69, 0x50, 0x44, 0x46, 0x2f, 0x2f, 0x4b, 0x30, 0x35, 0x64, 0x55, 0x59, 0x47, 0x6e, 0x67, 0x73, 0x77, 0x4d, 0x79, 0x63, 0x4b, 0x55, 0x30, 0x48, 0x73, 0x46, 0x58, 0x73, 0x4d, 0x36, 0x44, 0x76, 0xd, 0xa, 0x56, 0x66, 0x78, 0x6e, 0x56, 0x72, 0x4e, 0x5a, 0x32, 0x57, 0x2f, 0x74, 0x38, 0x45, 0x61, 0x76, 0x39, 0x57, 0x53, 0x4c, 0x6d, 0x65, 0x69, 0x44, 0x54, 0x7a, 0x6c, 0x58, 0x76, 0x78, 0x41, 0x76, 0x59, 0x67, 0x69, 0x46, 0x35, 0x6b, 0x32, 0x4d, 0x78, 0x74, 0x59, 0x39, 0x67, 0x6d, 0x72, 0x6d, 0x79, 0x33, 0x52, 0x36, 0x54, 0x65, 0x61, 0x44, 0x69, 0x45, 0x34, 0x4d, 0x2f, 0x39, 0x76, 0x6c, 0xd, 0xa, 0x70, 0x54, 0x78, 0x4e, 0x73, 0x74, 0x67, 0x31, 0x79, 0x56, 0x62, 0x44, 0x34, 0x48, 0x2b, 0x44, 0x70, 0x73, 0x71, 0x2f, 0x6a, 0x65, 0x33, 0x49, 0x36, 0x45, 0x78, 0x70, 0x75, 0x6c, 0x39, 0x59, 0x35, 0x31, 0x72, 0x46, 0x76, 0x69, 0x2b, 0x44, 0x43, 0x78, 0x55, 0x38, 0x53, 0x71, 0x56, 0x37, 0x66, 0x52, 0x4f, 0x61, 0x37, 0x79, 0x62, 0x61, 0x54, 0x59, 0x4c, 0x36, 0x71, 0x30, 0x6a, 0x65, 0xd, 0xa, 0x61, 0x65, 0x6c, 0x59, 0x64, 0x66, 0x31, 0x72, 0x31, 0x4e, 0x59, 0x2f, 0x64, 0x6f, 0x34, 0x79, 0x77, 0x66, 0x4f, 0x72, 0x54, 0x46, 0x37, 0x6f, 0x66, 0x30, 0x55, 0x52, 0x34, 0x79, 0x74, 0x45, 0x49, 0x34, 0x46, 0x51, 0x53, 0x52, 0x4e, 0x61, 0x66, 0x59, 0x52, 0x74, 0x53, 0x78, 0x56, 0x6f, 0x4f, 0x6e, 0x70, 0x73, 0x61, 0x74, 0x43, 0x57, 0x35, 0x70, 0x77, 0x70, 0x4c, 0x32, 0x45, 0x68, 0xd, 0xa, 0x74, 0x44, 0x54, 0x57, 0x51, 0x70, 0x2f, 0x52, 0x64, 0x66, 0x79, 0x65, 0x73, 0x55, 0x2b, 0x4b, 0x63, 0x78, 0x58, 0x64, 0x30, 0x57, 0x66, 0x55, 0x6e, 0x44, 0x41, 0x38, 0x46, 0x35, 0x72, 0x37, 0x50, 0x43, 0x6d, 0x53, 0x78, 0x4f, 0x4b, 0x38, 0x6d, 0x59, 0x49, 0x59, 0x30, 0x6e, 0x41, 0x49, 0x4e, 0x55, 0x2f, 0x7a, 0x6e, 0x35, 0x78, 0x2b, 0x75, 0x68, 0x33, 0x6e, 0x6e, 0x49, 0x4a, 0x4c, 0xd, 0xa, 0x41, 0x67, 0x4d, 0x42, 0x41, 0x41, 0x45, 0x3d, 0xd, 0xa, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x45, 0x4e, 0x44, 0x20, 0x50, 0x55, 0x42, 0x4c, 0x49, 0x43, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d}
	privateKeyRaw = []byte{0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x42, 0x45, 0x47, 0x49, 0x4e, 0x20, 0x52, 0x53, 0x41, 0x20, 0x50, 0x52, 0x49, 0x56, 0x41, 0x54, 0x45, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0xa, 0x4d, 0x49, 0x49, 0x45, 0x6f, 0x51, 0x49, 0x42, 0x41, 0x41, 0x4b, 0x43, 0x41, 0x51, 0x42, 0x56, 0x4b, 0x6f, 0x4a, 0x46, 0x6e, 0x30, 0x4d, 0x6a, 0x37, 0x59, 0x52, 0x59, 0x55, 0x4c, 0x4c, 0x36, 0x49, 0x63, 0x42, 0x43, 0x69, 0x49, 0x45, 0x52, 0x49, 0x2f, 0x6f, 0x2f, 0x30, 0x46, 0x47, 0x56, 0x53, 0x74, 0x61, 0x56, 0x75, 0x6e, 0x76, 0x52, 0x4f, 0x6f, 0x53, 0x37, 0x2f, 0x57, 0x6c, 0x7a, 0xa, 0x62, 0x6b, 0x75, 0x6c, 0x69, 0x50, 0x44, 0x46, 0x2f, 0x2f, 0x4b, 0x30, 0x35, 0x64, 0x55, 0x59, 0x47, 0x6e, 0x67, 0x73, 0x77, 0x4d, 0x79, 0x63, 0x4b, 0x55, 0x30, 0x48, 0x73, 0x46, 0x58, 0x73, 0x4d, 0x36, 0x44, 0x76, 0x56, 0x66, 0x78, 0x6e, 0x56, 0x72, 0x4e, 0x5a, 0x32, 0x57, 0x2f, 0x74, 0x38, 0x45, 0x61, 0x76, 0x39, 0x57, 0x53, 0x4c, 0x6d, 0x65, 0x69, 0x44, 0x54, 0x7a, 0x6c, 0x58, 0xa, 0x76, 0x78, 0x41, 0x76, 0x59, 0x67, 0x69, 0x46, 0x35, 0x6b, 0x32, 0x4d, 0x78, 0x74, 0x59, 0x39, 0x67, 0x6d, 0x72, 0x6d, 0x79, 0x33, 0x52, 0x36, 0x54, 0x65, 0x61, 0x44, 0x69, 0x45, 0x34, 0x4d, 0x2f, 0x39, 0x76, 0x6c, 0x70, 0x54, 0x78, 0x4e, 0x73, 0x74, 0x67, 0x31, 0x79, 0x56, 0x62, 0x44, 0x34, 0x48, 0x2b, 0x44, 0x70, 0x73, 0x71, 0x2f, 0x6a, 0x65, 0x33, 0x49, 0x36, 0x45, 0x78, 0x70, 0xa, 0x75, 0x6c, 0x39, 0x59, 0x35, 0x31, 0x72, 0x46, 0x76, 0x69, 0x2b, 0x44, 0x43, 0x78, 0x55, 0x38, 0x53, 0x71, 0x56, 0x37, 0x66, 0x52, 0x4f, 0x61, 0x37, 0x79, 0x62, 0x61, 0x54, 0x59, 0x4c, 0x36, 0x71, 0x30, 0x6a, 0x65, 0x61, 0x65, 0x6c, 0x59, 0x64, 0x66, 0x31, 0x72, 0x31, 0x4e, 0x59, 0x2f, 0x64, 0x6f, 0x34, 0x79, 0x77, 0x66, 0x4f, 0x72, 0x54, 0x46, 0x37, 0x6f, 0x66, 0x30, 0x55, 0x52, 0xa, 0x34, 0x79, 0x74, 0x45, 0x49, 0x34, 0x46, 0x51, 0x53, 0x52, 0x4e, 0x61, 0x66, 0x59, 0x52, 0x74, 0x53, 0x78, 0x56, 0x6f, 0x4f, 0x6e, 0x70, 0x73, 0x61, 0x74, 0x43, 0x57, 0x35, 0x70, 0x77, 0x70, 0x4c, 0x32, 0x45, 0x68, 0x74, 0x44, 0x54, 0x57, 0x51, 0x70, 0x2f, 0x52, 0x64, 0x66, 0x79, 0x65, 0x73, 0x55, 0x2b, 0x4b, 0x63, 0x78, 0x58, 0x64, 0x30, 0x57, 0x66, 0x55, 0x6e, 0x44, 0x41, 0x38, 0xa, 0x46, 0x35, 0x72, 0x37, 0x50, 0x43, 0x6d, 0x53, 0x78, 0x4f, 0x4b, 0x38, 0x6d, 0x59, 0x49, 0x59, 0x30, 0x6e, 0x41, 0x49, 0x4e, 0x55, 0x2f, 0x7a, 0x6e, 0x35, 0x78, 0x2b, 0x75, 0x68, 0x33, 0x6e, 0x6e, 0x49, 0x4a, 0x4c, 0x41, 0x67, 0x4d, 0x42, 0x41, 0x41, 0x45, 0x43, 0x67, 0x67, 0x45, 0x41, 0x4d, 0x45, 0x38, 0x76, 0x6e, 0x44, 0x79, 0x4f, 0x41, 0x6a, 0x67, 0x39, 0x78, 0x54, 0x62, 0x70, 0xa, 0x66, 0x7a, 0x64, 0x62, 0x37, 0x71, 0x47, 0x74, 0x7a, 0x4d, 0x4a, 0x43, 0x74, 0x71, 0x58, 0x39, 0x55, 0x52, 0x6b, 0x6c, 0x68, 0x63, 0x4e, 0x46, 0x62, 0x74, 0x61, 0x70, 0x36, 0x6c, 0x55, 0x42, 0x31, 0x77, 0x64, 0x75, 0x67, 0x35, 0x53, 0x64, 0x4e, 0x30, 0x4e, 0x4c, 0x4d, 0x6b, 0x2f, 0x59, 0x77, 0x35, 0x5a, 0x6f, 0x4b, 0x73, 0x4b, 0x6d, 0x6a, 0x63, 0x4a, 0x6a, 0x76, 0x6f, 0x50, 0x4a, 0xa, 0x43, 0x58, 0x58, 0x7a, 0x79, 0x53, 0x39, 0x57, 0x51, 0x47, 0x77, 0x4f, 0x79, 0x6c, 0x32, 0x72, 0x76, 0x79, 0x56, 0x33, 0x67, 0x32, 0x4a, 0x49, 0x53, 0x57, 0x50, 0x68, 0x58, 0x33, 0x4b, 0x32, 0x44, 0x55, 0x38, 0x45, 0x36, 0x45, 0x76, 0x4d, 0x6c, 0x39, 0x2b, 0x65, 0x68, 0x38, 0x64, 0x57, 0x53, 0x59, 0x66, 0x4d, 0x43, 0x65, 0x54, 0x49, 0x79, 0x6f, 0x4f, 0x62, 0x79, 0x57, 0x71, 0x74, 0xa, 0x45, 0x33, 0x53, 0x6a, 0x45, 0x4b, 0x33, 0x63, 0x2b, 0x68, 0x6f, 0x44, 0x79, 0x4f, 0x62, 0x50, 0x66, 0x38, 0x61, 0x39, 0x72, 0x6a, 0x6b, 0x54, 0x63, 0x76, 0x70, 0x77, 0x6d, 0x61, 0x4e, 0x5a, 0x65, 0x64, 0x73, 0x50, 0x61, 0x4a, 0x46, 0x72, 0x63, 0x57, 0x54, 0x48, 0x75, 0x51, 0x4a, 0x50, 0x6b, 0x54, 0x43, 0x76, 0x50, 0x55, 0x74, 0x33, 0x2b, 0x42, 0x34, 0x61, 0x52, 0x50, 0x47, 0x68, 0xa, 0x44, 0x76, 0x7a, 0x77, 0x4d, 0x4c, 0x2f, 0x6f, 0x34, 0x65, 0x71, 0x4e, 0x4e, 0x34, 0x68, 0x71, 0x4a, 0x56, 0x78, 0x65, 0x67, 0x57, 0x33, 0x51, 0x4e, 0x62, 0x69, 0x4d, 0x6c, 0x68, 0x57, 0x65, 0x48, 0x4a, 0x39, 0x56, 0x71, 0x2b, 0x6e, 0x52, 0x46, 0x6c, 0x41, 0x42, 0x53, 0x47, 0x74, 0x6c, 0x34, 0x64, 0x52, 0x7a, 0x52, 0x34, 0x56, 0x54, 0x36, 0x75, 0x6a, 0x52, 0x37, 0x31, 0x56, 0x77, 0xa, 0x2b, 0x68, 0x37, 0x49, 0x69, 0x4f, 0x75, 0x4d, 0x30, 0x6f, 0x38, 0x51, 0x30, 0x38, 0x50, 0x59, 0x6e, 0x64, 0x6d, 0x44, 0x53, 0x49, 0x67, 0x34, 0x69, 0x65, 0x71, 0x7a, 0x6e, 0x68, 0x59, 0x42, 0x4f, 0x4d, 0x43, 0x74, 0x4d, 0x48, 0x74, 0x75, 0x30, 0x31, 0x4e, 0x79, 0x4b, 0x69, 0x4e, 0x51, 0x74, 0x4a, 0x33, 0x4a, 0x32, 0x76, 0x73, 0x73, 0x52, 0x48, 0x5a, 0x6c, 0x4d, 0x48, 0x79, 0x37, 0xa, 0x46, 0x67, 0x72, 0x65, 0x65, 0x51, 0x4b, 0x42, 0x67, 0x51, 0x43, 0x59, 0x56, 0x77, 0x67, 0x76, 0x77, 0x38, 0x38, 0x41, 0x53, 0x42, 0x6a, 0x73, 0x33, 0x54, 0x44, 0x61, 0x57, 0x74, 0x6c, 0x6b, 0x33, 0x37, 0x78, 0x6a, 0x55, 0x44, 0x78, 0x52, 0x58, 0x4c, 0x4f, 0x51, 0x30, 0x50, 0x37, 0x73, 0x38, 0x37, 0x4c, 0x48, 0x2f, 0x30, 0x2b, 0x45, 0x4d, 0x63, 0x51, 0x4c, 0x67, 0x47, 0x32, 0x43, 0xa, 0x72, 0x54, 0x70, 0x53, 0x54, 0x63, 0x47, 0x79, 0x57, 0x66, 0x2f, 0x6d, 0x52, 0x50, 0x6d, 0x35, 0x62, 0x71, 0x71, 0x32, 0x76, 0x76, 0x78, 0x4d, 0x6f, 0x34, 0x72, 0x72, 0x62, 0x58, 0x61, 0x32, 0x63, 0x68, 0x31, 0x69, 0x70, 0x37, 0x66, 0x42, 0x69, 0x37, 0x47, 0x64, 0x38, 0x49, 0x33, 0x30, 0x63, 0x6a, 0x32, 0x42, 0x37, 0x2f, 0x5a, 0x6d, 0x4d, 0x32, 0x7a, 0x54, 0x34, 0x49, 0x6d, 0x53, 0xa, 0x7a, 0x6c, 0x71, 0x44, 0x6a, 0x37, 0x47, 0x71, 0x43, 0x74, 0x79, 0x4a, 0x55, 0x77, 0x77, 0x4b, 0x32, 0x4e, 0x59, 0x51, 0x71, 0x45, 0x5a, 0x37, 0x61, 0x37, 0x2b, 0x75, 0x37, 0x45, 0x57, 0x73, 0x49, 0x4a, 0x56, 0x6c, 0x6c, 0x53, 0x79, 0x58, 0x61, 0x50, 0x63, 0x32, 0x69, 0x68, 0x69, 0x63, 0x55, 0x67, 0x36, 0x31, 0x62, 0x51, 0x4b, 0x42, 0x67, 0x51, 0x43, 0x50, 0x48, 0x68, 0x47, 0x6c, 0xa, 0x42, 0x69, 0x47, 0x38, 0x76, 0x48, 0x39, 0x37, 0x38, 0x61, 0x36, 0x4e, 0x4e, 0x4e, 0x6e, 0x5a, 0x66, 0x59, 0x46, 0x51, 0x36, 0x61, 0x74, 0x64, 0x55, 0x41, 0x2b, 0x65, 0x39, 0x37, 0x61, 0x4b, 0x31, 0x75, 0x79, 0x34, 0x4f, 0x65, 0x4b, 0x59, 0x2b, 0x71, 0x42, 0x5a, 0x64, 0x6b, 0x77, 0x43, 0x73, 0x55, 0x39, 0x52, 0x49, 0x2b, 0x74, 0x62, 0x69, 0x58, 0x2f, 0x33, 0x47, 0x69, 0x69, 0x45, 0xa, 0x4e, 0x4a, 0x39, 0x70, 0x4d, 0x6e, 0x2f, 0x30, 0x2f, 0x75, 0x35, 0x45, 0x53, 0x33, 0x4b, 0x50, 0x59, 0x37, 0x74, 0x4e, 0x4c, 0x62, 0x58, 0x4e, 0x56, 0x65, 0x56, 0x39, 0x37, 0x69, 0x65, 0x52, 0x4c, 0x62, 0x71, 0x6c, 0x54, 0x59, 0x55, 0x33, 0x69, 0x50, 0x70, 0x49, 0x35, 0x53, 0x4c, 0x6c, 0x50, 0x7a, 0x41, 0x4e, 0x6f, 0x2f, 0x6f, 0x71, 0x43, 0x61, 0x35, 0x41, 0x76, 0x41, 0x52, 0x5a, 0xa, 0x33, 0x73, 0x69, 0x32, 0x66, 0x66, 0x51, 0x70, 0x78, 0x56, 0x73, 0x7a, 0x33, 0x79, 0x6f, 0x4d, 0x37, 0x39, 0x34, 0x39, 0x64, 0x77, 0x71, 0x75, 0x69, 0x41, 0x6c, 0x54, 0x64, 0x61, 0x79, 0x36, 0x47, 0x2b, 0x45, 0x62, 0x6c, 0x77, 0x4b, 0x42, 0x67, 0x46, 0x6f, 0x4c, 0x4c, 0x31, 0x4b, 0x55, 0x53, 0x58, 0x6c, 0x67, 0x4a, 0x43, 0x4e, 0x31, 0x52, 0x6c, 0x66, 0x36, 0x56, 0x50, 0x37, 0x7a, 0xa, 0x34, 0x2f, 0x56, 0x4c, 0x79, 0x71, 0x74, 0x49, 0x77, 0x50, 0x5a, 0x37, 0x49, 0x67, 0x4e, 0x4b, 0x74, 0x45, 0x54, 0x55, 0x6d, 0x74, 0x71, 0x48, 0x55, 0x39, 0x70, 0x38, 0x69, 0x62, 0x34, 0x77, 0x79, 0x41, 0x55, 0x33, 0x34, 0x71, 0x4b, 0x5a, 0x34, 0x64, 0x44, 0x6f, 0x75, 0x6a, 0x61, 0x70, 0x76, 0x41, 0x77, 0x53, 0x62, 0x53, 0x79, 0x62, 0x69, 0x68, 0x52, 0x48, 0x2b, 0x6d, 0x41, 0x79, 0xa, 0x71, 0x54, 0x33, 0x54, 0x35, 0x71, 0x42, 0x6e, 0x41, 0x70, 0x42, 0x5a, 0x54, 0x48, 0x37, 0x4e, 0x4f, 0x35, 0x2f, 0x66, 0x42, 0x32, 0x51, 0x33, 0x52, 0x7a, 0x38, 0x68, 0x50, 0x41, 0x2f, 0x6a, 0x47, 0x73, 0x73, 0x69, 0x6c, 0x78, 0x2f, 0x73, 0x46, 0x5a, 0x69, 0x78, 0x31, 0x71, 0x39, 0x65, 0x70, 0x59, 0x44, 0x70, 0x42, 0x65, 0x67, 0x54, 0x73, 0x78, 0x51, 0x67, 0x6f, 0x62, 0x6e, 0x77, 0xa, 0x39, 0x48, 0x30, 0x37, 0x70, 0x45, 0x54, 0x47, 0x6a, 0x55, 0x44, 0x57, 0x64, 0x56, 0x2b, 0x49, 0x66, 0x52, 0x73, 0x74, 0x41, 0x6f, 0x47, 0x41, 0x45, 0x31, 0x78, 0x38, 0x41, 0x70, 0x6b, 0x37, 0x77, 0x79, 0x36, 0x31, 0x43, 0x47, 0x31, 0x2f, 0x73, 0x62, 0x61, 0x75, 0x71, 0x67, 0x2b, 0x69, 0x69, 0x50, 0x47, 0x7a, 0x72, 0x79, 0x48, 0x2f, 0x6d, 0x76, 0x2f, 0x6b, 0x41, 0x42, 0x42, 0x6e, 0xa, 0x59, 0x64, 0x7a, 0x69, 0x33, 0x4e, 0x4d, 0x37, 0x45, 0x68, 0x39, 0x41, 0x31, 0x54, 0x52, 0x72, 0x69, 0x49, 0x79, 0x56, 0x63, 0x49, 0x4b, 0x2f, 0x66, 0x77, 0x78, 0x59, 0x34, 0x74, 0x6e, 0x44, 0x6e, 0x78, 0x57, 0x6e, 0x33, 0x64, 0x73, 0x48, 0x48, 0x4e, 0x49, 0x67, 0x49, 0x32, 0x6e, 0x59, 0x6b, 0x75, 0x35, 0x57, 0x49, 0x2f, 0x73, 0x30, 0x32, 0x72, 0x35, 0x33, 0x4e, 0x39, 0x71, 0x35, 0xa, 0x33, 0x31, 0x63, 0x48, 0x61, 0x4b, 0x58, 0x74, 0x52, 0x69, 0x4e, 0x4a, 0x66, 0x7a, 0x33, 0x33, 0x49, 0x45, 0x46, 0x49, 0x76, 0x4a, 0x73, 0x6d, 0x71, 0x62, 0x64, 0x46, 0x31, 0x32, 0x71, 0x65, 0x4f, 0x4b, 0x48, 0x39, 0x67, 0x42, 0x45, 0x6b, 0x37, 0x33, 0x57, 0x48, 0x57, 0x4d, 0x79, 0x79, 0x67, 0x68, 0x6f, 0x79, 0x70, 0x62, 0x33, 0x64, 0x6c, 0x52, 0x37, 0x63, 0x53, 0x53, 0x6b, 0x77, 0xa, 0x59, 0x4f, 0x30, 0x43, 0x67, 0x59, 0x41, 0x6c, 0x35, 0x65, 0x56, 0x79, 0x57, 0x35, 0x42, 0x31, 0x55, 0x33, 0x59, 0x52, 0x79, 0x45, 0x4f, 0x42, 0x65, 0x47, 0x64, 0x73, 0x53, 0x43, 0x78, 0x76, 0x47, 0x33, 0x63, 0x6a, 0x63, 0x66, 0x31, 0x58, 0x50, 0x6c, 0x37, 0x38, 0x67, 0x6b, 0x47, 0x71, 0x62, 0x79, 0x79, 0x33, 0x39, 0x4b, 0x63, 0x53, 0x49, 0x44, 0x61, 0x6a, 0x4f, 0x2f, 0x48, 0x7a, 0xa, 0x51, 0x4a, 0x79, 0x30, 0x48, 0x56, 0x4a, 0x5a, 0x66, 0x59, 0x49, 0x56, 0x32, 0x4d, 0x5a, 0x6c, 0x4e, 0x7a, 0x6e, 0x58, 0x65, 0x56, 0x50, 0x49, 0x78, 0x48, 0x47, 0x36, 0x4b, 0x49, 0x55, 0x52, 0x36, 0x66, 0x6e, 0x45, 0x41, 0x67, 0x52, 0x44, 0x34, 0x65, 0x4c, 0x47, 0x4b, 0x6a, 0x58, 0x6b, 0x36, 0x32, 0x6d, 0x55, 0x37, 0x4f, 0x78, 0x49, 0x76, 0x76, 0x6b, 0x5a, 0x59, 0x44, 0x76, 0x43, 0xa, 0x52, 0x37, 0x62, 0x52, 0x72, 0x53, 0x4e, 0x64, 0x72, 0x53, 0x42, 0x74, 0x32, 0x47, 0x2f, 0x62, 0x57, 0x43, 0x31, 0x50, 0x76, 0x43, 0x6e, 0x6b, 0x4d, 0x63, 0x32, 0x47, 0x39, 0x4d, 0x46, 0x62, 0x32, 0x33, 0x74, 0x52, 0x6f, 0x45, 0x73, 0x6e, 0x46, 0x68, 0x57, 0x31, 0x67, 0x62, 0x32, 0x65, 0x68, 0x67, 0x3d, 0x3d, 0xa, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d, 0x45, 0x4e, 0x44, 0x20, 0x52, 0x53, 0x41, 0x20, 0x50, 0x52, 0x49, 0x56, 0x41, 0x54, 0x45, 0x20, 0x4b, 0x45, 0x59, 0x2d, 0x2d, 0x2d, 0x2d, 0x2d}
)

type DecryptSuite struct {
	suite.Suite
	ts        *httptest.Server
	client    *resty.Client
	publicKey []byte
}

func (s *DecryptSuite) SetupSuite() {
	publicKey, err := cryptokey.DecodeKey(publicKeyRaw)
	s.Require().NoError(err)
	s.publicKey = publicKey

	privateKey, err := cryptokey.DecodeKey(privateKeyRaw)
	s.Require().NoError(err)

	r := chi.NewRouter()
	r.Use(Decrypt(privateKey))

	r.Post("/test/", func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "text/plain; charset=utf-8")
		w.WriteHeader(http.StatusOK)
		_, err := io.Copy(w, r.Body)
		s.Require().NoError(err)
	})

	s.ts = httptest.NewServer(r)
	s.client = resty.New().SetBaseURL(s.ts.URL)
}

func (s *DecryptSuite) TearDownSuite() {
	s.ts.Close()
}

func (s *DecryptSuite) sendRequest(data []byte) *resty.Response {
	req := s.client.R().SetBody(data)

	resp, err := req.Post("test/")
	s.Require().NoError(err)

	return resp
}

func (s *DecryptSuite) encode(data []byte) []byte {
	encoded, err := cryptokey.Encrypt(data, s.publicKey)
	s.Require().NoError(err)
	s.NotEqual(data, encoded)

	return encoded
}

func (s *DecryptSuite) TestDecrypt() {
	testCases := []struct {
		name string
		msg  []byte
		want []byte
	}{
		{
			name: "Positive",
			msg:  s.encode([]byte(`{"message":"Hello"}`)),
			want: []byte(`{"message":"Hello"}`),
		},
		{
			name: "Large data",
			msg: s.encode([]byte("Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut ipsum nisi, interdum eget iaculis sit amet, hendrerit non risus. Sed aliquet, mauris eget rutrum egestas, orci lectus mollis nibh, sed ornare metus erat eu ex. Pellentesque id ante eu tellus egestas pellentesque at eu leo. Morbi egestas tortor sit amet augue tincidunt aliquet. Curabitur vitae metus vel metus eleifend blandit sed non tortor. Sed et erat quam. Vestibulum nunc tortor, tincidunt ut finibus nec, scelerisque et turpis. Aenean placerat, neque eu efficitur dictum, nunc arcu maximus mauris, eu commodo massa risus et quam. Sed et gravida dui. Nunc nulla tortor, interdum et nisi et, malesuada sollicitudin purus. Ut sollicitudin ultrices porta. Vivamus eu placerat elit, sit amet tincidunt nisi. Donec finibus sollicitudin quam, a consectetur sapien tristique in. Nulla porta lorem ut libero fermentum laoreet. Aliquam dapibus porttitor neque eleifend suscipit.\n" +
				"In nec ipsum fermentum diam rutrum ultricies vel eu mi. Etiam vitae massa neque. Sed cursus eros lorem, in gravida ipsum consectetur vitae. Praesent sit amet leo quam. Praesent orci tortor, porttitor ut diam sit amet, porta volutpat lorem. Morbi eget tincidunt ante. Donec rutrum nec urna sed dignissim. Integer eleifend cursus tellus, vel sagittis tellus euismod eu.\n" +
				"Phasellus eu euismod dui, eleifend finibus orci. Sed in dui ornare, efficitur sem porta, congue magna. Phasellus a laoreet nisl. Ut luctus risus urna, nec sodales lacus ultricies eget. In eleifend, leo vel aliquam maximus, nisl nunc posuere elit, quis iaculis nulla urna ut justo. Aliquam et nunc interdum, egestas libero id, consectetur est. Praesent laoreet ut mi eget sodales.\n" +
				"Ut faucibus maximus neque id eleifend. Etiam sed est posuere lectus volutpat sollicitudin et vitae dolor. Mauris rhoncus sed lectus et bibendum. Sed ut scelerisque ligula. Pellentesque tincidunt ante vitae ipsum malesuada tristique. Integer ut tincidunt est, quis suscipit turpis. Cras rutrum lorem dui, eu accumsan quam ornare vel. Nullam commodo non ex non convallis. Nulla venenatis nunc dui, ut rutrum ligula dapibus vitae. Vestibulum malesuada, diam at posuere tempor, arcu ligula hendrerit orci, a pharetra mi lacus vel libero. Proin vitae lobortis nibh. Phasellus efficitur aliquam erat, et posuere leo sagittis ut. Donec vitae purus sed turpis scelerisque accumsan at vel elit. Sed mi orci, varius quis justo a, ullamcorper sodales sapien. Aliquam nec massa quis eros egestas tristique vitae quis nibh. Donec sit amet est quis enim tempor fringilla in ut orci.\n" +
				"Aenean consequat, ipsum id tempus auctor, libero magna volutpat enim, quis ornare eros lectus nec dui. Aenean eu eros id diam porta mollis. Aenean faucibus justo vitae diam egestas, non bibendum nisl tristique. Fusce ultricies ullamcorper ligula fringilla dignissim. Nam sit amet ipsum non purus molestie eleifend vel ac purus. Donec a ante libero. Vivamus volutpat turpis quis diam auctor viverra. Aliquam id imperdiet purus, ut ornare risus. Pellentesque in ipsum cursus, faucibus urna a, posuere risus.\n" +
				"Duis lectus ligula, mollis in augue sed, ornare commodo leo. Aliquam arcu enim, scelerisque eu libero in, ultricies consectetur lorem. Ut ac risus vel elit vulputate fermentum id ut dui. Fusce aliquet quis augue ut cursus. Donec suscipit, enim in venenatis sodales, purus lorem elementum odio, non blandit lorem arcu a magna. Proin ullamcorper massa sit amet risus gravida, nec tincidunt nulla congue. Vivamus mattis mollis sodales. Aenean ac augue congue, mollis sapien quis, sollicitudin diam. Aliquam erat volutpat. Nulla nec arcu non est bibendum venenatis. Nam iaculis varius sodales. Nunc nec tellus non sapien semper convallis. Vivamus imperdiet tortor ac quam viverra, sit amet fermentum ligula dictum. Curabitur ac mauris suscipit, congue mi vel, sagittis justo. Morbi non posuere nisl, a eleifend nibh.\n" +
				"Sed scelerisque suscipit purus, id iaculis nisl mollis eu. Proin auctor egestas velit, feugiat ullamcorper metus consectetur non. Donec sed ornare metus, non laoreet diam. Curabitur odio ante, dignissim eget ex ac, aliquet euismod erat. Mauris rutrum ante ex, vel placerat elit congue at. Pellentesque laoreet ut purus non sollicitudin. Maecenas pharetra eget dolor nec fermentum. Vestibulum at quam tristique, tincidunt ex ac, molestie felis. Suspendisse tincidunt arcu sit amet lorem aliquam ultricies. Proin non placerat orci. Nam viverra tellus sed molestie aliquet.\n" +
				"Nam tincidunt pellentesque arcu in congue. Curabitur eget magna viverra, congue risus auctor, pretium felis. Sed vulputate fringilla magna at bibendum. Nulla sed eleifend enim, non luctus elit. Sed et nisi convallis justo sodales tempus. Nulla quis congue urna. Mauris vitae dictum risus. Nulla euismod rutrum nunc, non maximus ante vestibulum vitae. Integer lacinia sapien est. Nam suscipit nibh rutrum consequat facilisis. Nam nec metus placerat, euismod erat nec, placerat nibh. Duis sed consequat nunc. Quisque tincidunt, enim et sodales congue, magna purus mi.")),
			want: []byte("Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut ipsum nisi, interdum eget iaculis sit amet, hendrerit non risus. Sed aliquet, mauris eget rutrum egestas, orci lectus mollis nibh, sed ornare metus erat eu ex. Pellentesque id ante eu tellus egestas pellentesque at eu leo. Morbi egestas tortor sit amet augue tincidunt aliquet. Curabitur vitae metus vel metus eleifend blandit sed non tortor. Sed et erat quam. Vestibulum nunc tortor, tincidunt ut finibus nec, scelerisque et turpis. Aenean placerat, neque eu efficitur dictum, nunc arcu maximus mauris, eu commodo massa risus et quam. Sed et gravida dui. Nunc nulla tortor, interdum et nisi et, malesuada sollicitudin purus. Ut sollicitudin ultrices porta. Vivamus eu placerat elit, sit amet tincidunt nisi. Donec finibus sollicitudin quam, a consectetur sapien tristique in. Nulla porta lorem ut libero fermentum laoreet. Aliquam dapibus porttitor neque eleifend suscipit.\n" +
				"In nec ipsum fermentum diam rutrum ultricies vel eu mi. Etiam vitae massa neque. Sed cursus eros lorem, in gravida ipsum consectetur vitae. Praesent sit amet leo quam. Praesent orci tortor, porttitor ut diam sit amet, porta volutpat lorem. Morbi eget tincidunt ante. Donec rutrum nec urna sed dignissim. Integer eleifend cursus tellus, vel sagittis tellus euismod eu.\n" +
				"Phasellus eu euismod dui, eleifend finibus orci. Sed in dui ornare, efficitur sem porta, congue magna. Phasellus a laoreet nisl. Ut luctus risus urna, nec sodales lacus ultricies eget. In eleifend, leo vel aliquam maximus, nisl nunc posuere elit, quis iaculis nulla urna ut justo. Aliquam et nunc interdum, egestas libero id, consectetur est. Praesent laoreet ut mi eget sodales.\n" +
				"Ut faucibus maximus neque id eleifend. Etiam sed est posuere lectus volutpat sollicitudin et vitae dolor. Mauris rhoncus sed lectus et bibendum. Sed ut scelerisque ligula. Pellentesque tincidunt ante vitae ipsum malesuada tristique. Integer ut tincidunt est, quis suscipit turpis. Cras rutrum lorem dui, eu accumsan quam ornare vel. Nullam commodo non ex non convallis. Nulla venenatis nunc dui, ut rutrum ligula dapibus vitae. Vestibulum malesuada, diam at posuere tempor, arcu ligula hendrerit orci, a pharetra mi lacus vel libero. Proin vitae lobortis nibh. Phasellus efficitur aliquam erat, et posuere leo sagittis ut. Donec vitae purus sed turpis scelerisque accumsan at vel elit. Sed mi orci, varius quis justo a, ullamcorper sodales sapien. Aliquam nec massa quis eros egestas tristique vitae quis nibh. Donec sit amet est quis enim tempor fringilla in ut orci.\n" +
				"Aenean consequat, ipsum id tempus auctor, libero magna volutpat enim, quis ornare eros lectus nec dui. Aenean eu eros id diam porta mollis. Aenean faucibus justo vitae diam egestas, non bibendum nisl tristique. Fusce ultricies ullamcorper ligula fringilla dignissim. Nam sit amet ipsum non purus molestie eleifend vel ac purus. Donec a ante libero. Vivamus volutpat turpis quis diam auctor viverra. Aliquam id imperdiet purus, ut ornare risus. Pellentesque in ipsum cursus, faucibus urna a, posuere risus.\n" +
				"Duis lectus ligula, mollis in augue sed, ornare commodo leo. Aliquam arcu enim, scelerisque eu libero in, ultricies consectetur lorem. Ut ac risus vel elit vulputate fermentum id ut dui. Fusce aliquet quis augue ut cursus. Donec suscipit, enim in venenatis sodales, purus lorem elementum odio, non blandit lorem arcu a magna. Proin ullamcorper massa sit amet risus gravida, nec tincidunt nulla congue. Vivamus mattis mollis sodales. Aenean ac augue congue, mollis sapien quis, sollicitudin diam. Aliquam erat volutpat. Nulla nec arcu non est bibendum venenatis. Nam iaculis varius sodales. Nunc nec tellus non sapien semper convallis. Vivamus imperdiet tortor ac quam viverra, sit amet fermentum ligula dictum. Curabitur ac mauris suscipit, congue mi vel, sagittis justo. Morbi non posuere nisl, a eleifend nibh.\n" +
				"Sed scelerisque suscipit purus, id iaculis nisl mollis eu. Proin auctor egestas velit, feugiat ullamcorper metus consectetur non. Donec sed ornare metus, non laoreet diam. Curabitur odio ante, dignissim eget ex ac, aliquet euismod erat. Mauris rutrum ante ex, vel placerat elit congue at. Pellentesque laoreet ut purus non sollicitudin. Maecenas pharetra eget dolor nec fermentum. Vestibulum at quam tristique, tincidunt ex ac, molestie felis. Suspendisse tincidunt arcu sit amet lorem aliquam ultricies. Proin non placerat orci. Nam viverra tellus sed molestie aliquet.\n" +
				"Nam tincidunt pellentesque arcu in congue. Curabitur eget magna viverra, congue risus auctor, pretium felis. Sed vulputate fringilla magna at bibendum. Nulla sed eleifend enim, non luctus elit. Sed et nisi convallis justo sodales tempus. Nulla quis congue urna. Mauris vitae dictum risus. Nulla euismod rutrum nunc, non maximus ante vestibulum vitae. Integer lacinia sapien est. Nam suscipit nibh rutrum consequat facilisis. Nam nec metus placerat, euismod erat nec, placerat nibh. Duis sed consequat nunc. Quisque tincidunt, enim et sodales congue, magna purus mi."),
		},
	}

	for _, tc := range testCases {
		s.Run(tc.name, func() {
			resp := s.sendRequest(tc.msg)
			s.Equal(tc.want, resp.Body())
		})
	}
}

func TestDecryptSuite(t *testing.T) {
	suite.Run(t, new(DecryptSuite))
}
